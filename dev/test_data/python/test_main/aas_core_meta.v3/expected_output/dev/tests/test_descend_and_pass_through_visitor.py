"""
Test jointly :py:method:`aas_core3.types.Class.descend` and
:py:method:`aas_core3.types.PassThroughVisitor`.
"""


# This code has been automatically generated by aas-core-codegen.
# Do NOT edit or append.


# pylint: disable=missing-docstring


from typing import (
    List,
    Sequence
)
import unittest


import aas_core3.types as aas_types


import tests.common_xmlization


class _TracingVisitor(aas_types.PassThroughVisitor):
    """Visit the instances and trace them."""

    def __init__(self) -> None:
        """Initialize with an empty log."""
        self._log = []  # type: List[str]

    @property
    def log(self) -> Sequence[str]:
        """Get the tracing log."""
        return self._log

    def visit(self, that: aas_types.Class) -> None:
        self._log.append(tests.common.trace(that))
        super().visit(that)


def assert_tracing_logs_from_descend_and_visitor_are_the_same(
    that: aas_types.Class, test_case: unittest.TestCase
) -> None:
    """
    Check that the tracing logs are the same when :paramref:`that` instance
    is visited and when :paramref:`that` is ran through
    :py:method:`aas_types.Class.descend`.

    :param that: instance to be iterated over
    :param test_case: in which this assertion runs
    :raise: :py:class:`AssertionError` if the logs differ
    """
    log_from_descend = [tests.common.trace(something) for something in that.descend()]

    visitor = _TracingVisitor()
    visitor.visit(that)
    log_from_visitor = visitor.log

    test_case.assertGreater(len(log_from_visitor), 0)
    test_case.assertEqual(tests.common.trace(that), log_from_visitor[0])

    # noinspection PyTypeChecker
    test_case.assertListEqual(log_from_descend, log_from_visitor[1:])  # type: ignore


class TestWithExpectedMaximal(unittest.TestCase):
    def test_descend_against_recorded_trace_log(self) -> None:
        xml_expected_dir = tests.common.TEST_DATA_DIR / "Xml" / "Expected"

        for path in sorted(xml_expected_dir.glob("**/maximal.xml")):
            instance = tests.common_xmlization.must_load(path)

            rel_path = path.relative_to(xml_expected_dir)

            expected_path = (
                tests.common.TEST_DATA_DIR
                / "descend_and_pass_through_visitor"
                / rel_path.parent
                / f"{rel_path.name}.trace"
            )

            log = [
                tests.common.trace(something)
                for something in instance.descend()
            ]

            got_text = tests.common.trace_log_as_text_file_content(log)

            tests.common.record_or_check(expected_path, got_text)

    def test_descend_against_visitor(self) -> None:
        xml_expected_dir = tests.common.TEST_DATA_DIR / "Xml" / "Expected"

        for path in sorted(xml_expected_dir.glob("**/maximal.xml")):
            instance = tests.common_xmlization.must_load(path)

            assert_tracing_logs_from_descend_and_visitor_are_the_same(
                instance,
                self
            )


if __name__ == "__main__":
    unittest.main()


# This code has been automatically generated by aas-core-codegen.
# Do NOT edit or append.
